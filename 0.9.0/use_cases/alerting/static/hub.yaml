apiVersion: hub.mydecisive.ai/v1
kind: MdaiHub
metadata:
  labels:
    app.kubernetes.io/name: mdai-operator
    app.kubernetes.io/managed-by: kustomize
  name: mdaihub-ia
  namespace: mdai
spec:
  prometheusAlerts:
    - name: anomalous_error_rate
      # two part query
      # first part checks if the error rate is a specific multiplier of the normal error rate over the last hour
      # second part ensures there is at least an hour's worth of data to check against, to prevent false-positives
      expr: 'sum(increase(error_logs_by_service_total[5m])) by (mdai_service) > 2 * sum(avg_over_time(increase(error_logs_by_service_total[5m])[1h:])) by (mdai_service) and (sum by (mdai_service) (error_logs_by_service_total offset 1h))'
      # Replace the above line with the following to test lower thresholds
      # expr: 'sum(increase(error_logs_by_service_total[5m])) by (mdai_service) > 0.1 * sum(avg_over_time(increase(error_logs_by_service_total[5m])[1h:])) by (mdai_service)'
      severity: warning
      for: 3m
      keep_firing_for: 3m
    
    #
    - name: unmasked_cc_detected
      expr: 'sum(increase(cc_unmasked_logs_total[5m])) by (mdai_service) > 0'
      severity: critical
      for: 1m
      keep_firing_for: 10m

  rules:
    - name: anomalous_error_rate
      when:
        alertName: anomalous_error_rate
        status: firing
      then:
        - callWebhook:
            url:
              valueFrom:
                # Read the URL from a Secret (recommended)
                secretKeyRef: {name: slack-webhook-secret, key: url }
            templateRef: slackAlertTemplate
            templateValues:
              labels_val_ref_primary: mdai_service
              message: Service was >2x expected error rate for five minutes compared to the last hour!
              link_url: http://localhost:9090/alerts
              link_text: See alert in Prometheus

    - name: unmasked_cc_detected
      when:
        alertName: unmasked_cc_detected
        status: firing
      then:
        - callWebhook:
            url:
              valueFrom:
                secretKeyRef: { name: slack-webhook-secret, key: url }
            templateRef: slackAlertTemplate
            templateValues:
              labels_val_ref_primary: mdai_service
              message: Unmasked credit card data detected in logs (cc attribute). Investigate immediately.
              link_text: See alert in Prometheus
              link_url: http://localhost:9090/alerts
              
